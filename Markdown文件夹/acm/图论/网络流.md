# 网络流

网络流指，在一张有且仅有一个源点S，有且仅有一个汇点T，边权代表最大能容纳多少流量的图上，进行运算的算法。

## 流量网络 & 残留网络

定义$c_f<u,v> = c<u,v> - f<u,v>$，$f$为流量，$c$为容量，$c_f$为残余容量。

**残余容量 + 反向平衡的流量** 构成了残留网络。

## dinic

分层次来找増广路，每次可实现找多条増广路，且尽量走短的边（能走短的増广路肯定就走短的吧，走完短的，很多长的増广路可能就已经失效了）。

**当前弧优化** ：~~被qzjj骂了一顿，不过不会就要问嘛，不能因为尊重导师而假装自己会这知识点（虽然下次最好在计划安排的对应专题问对应的问题）~~

对于链式前向星储存图，先遍历的边总会被优先加载更多的流量。而对于当前分层图，已经跑满了的边，若重复跑边是很浪费时间的。

具体举两个例子，感受一下：

> S→A有1e5条容量1的边，
> A→T有1e5条容量1的边
>
> S→A有1e5条容量1的边，
> A→T有1条容量1e5的边

对于这种边结构，再搞复杂一点，就被卡死了。

那么只需要不再遍历这些满流边即可。

用cur来存储当前能遍历的边（不能遍历的 **必然是满流边** ）。每次分层时重新给cur赋值。

对于提供的流量不比当前边的容量大时，由于flow=0，跳出了循环，故下次还会遍历这条边。不然flow必然大于当前边的容量，使边满流，那么这时就再也不会遍历这条边了。实现了优化。

## 最小割

对于S，T，将其两个的流量网络彻底断开所耗费的流量称作 **割** ，其中流量耗费最小的是 **最小割** 。

最小割等于最大流。。不太想写证明了。

最小割问题，有取最小或取最大问题。对于取最大，先~~做白日梦？~~取完所有有收益的，然后建失去收益的边。求出来的即是最小代价，减去后即为最大收益。

注意，最小割，割去的是边，而这个边是来自于对边的定义。所以在做最小割建图，关注点应该在如何定义边。

## Ford - Fulkson方法

指从源点到汇点，每次找一条増广路进行扩流，直到不存在増广路为止。dinic，ISAP，以及最小费用最大流均基于此方法稍作改进得来。

## 删点操作

这里提到的删点，并不是一个算法。当建出来的图复杂度过高的时候，去考虑哪些点能删除，或者合并，以保证最后建出来的图是满足复杂度要求的。

可以删除的点：没有流出的流量，或者没有流入的流量。

可以合并的点：两个点<u,v>的容量为inf，且v没有其他的流量来源，此时u，v视为一个点。

两个点的来源相同，即连向他俩的点一样，且容量相同，此时可以合并成一个点，且容量翻倍。

两个点的去向相同，即连出的点一样，且容量相同，此时可以合并成一个点，且容量翻倍。

## 最大权闭合子图

其实就是最小割的应用。对于一个图，有正权有负权，每次选一个点，与其可到达的所有点都得被选上，问图的最大权方案。

假设正权点都选了啊，那么不选最大权是否要支付费用？割了负权的边，是不是得支付费用？于是原图的所有边容量为inf，S向正权点连点权容量的边，负权点向T连负点权容量的边，跑个最小割即可。

## 有上下界的网络流

即一些边至少流满xx流量，至多流满yy流量，的模型。

对于这种模型啊，就在原图保留上界R减下界L的边，然后对于点u的顶标-L，点v的顶标+L。

对于包括源点S汇点T的点，当顶标>0，超级源SS向点u连顶标值大小流量的边。当顶标<0，u向超级汇TT连顶标值的绝对值流量的边。

先跑一遍dinic(SS,TT)，然后连接<T,S,inf>，再跑一次dinic(SS,TT)，此时啊，T->S的反边就是最小流了！

之后去除T->S这条边，然后跑dinic(S,T)（由于原图可能没跑满），最大流就等于最小流加上dinic(S,T)的值了。

画图呢，是能感性理解正确性的。

## 一些习题

### P2764 最小路径覆盖问题

首先，用最少的路径覆盖所有的点，意味着一条路径上尽量用多一些点。将点拆成入点出点，出点向有边的入点连边。

最小路径覆盖 = n - 最大流

根据残余网路，将选中的点用pre[],nxt[]串起来，最后输出若干条链就好了。

### P2765 魔术球问题

经验丰富的选手选择拆点。

由于网络流可撤销之前操作，所以动态加新点即可。很显然，需要用尽量少的柱子来装下尽量多的数，那不就是最小路径覆盖嘛。

所以按照最小路径覆盖模型来建图，给能挨在一块的数的出点入点连条边，当用的数 - 网络流 > 柱子个数就停止。

### P2766 最长不下降子序列问题

首先肯定要LIS一下的。

将LIS和LIS+1的位置串起来，等于LIS值的指向汇点T，跑网络流。（不然你瞎连的话会导致流量对应的实际情况不合法）

### P3171 [CQOI2015]网络吞吐量

水题。把最短路保留下来跑网络流即可。

### P3163 [CQOI2014]危桥

结论题。。先让S连a1，b1，T连a2，b2跑看是否满流，再让S连a1，b2，T连a2，b1，看是否满流。

不适用于两点以上情况。

### P2472 [SCOI2007]蜥蜴

水题。限制石柱被经过的次数，就拆点呗。

### SP4063 MPIGS - Sell Pigs

这题很有意思。

把猪圈里的猪的数量当做边，从汇点连向第i天的顾客，顾客则向T连自己的需求量。怎么考虑将并在一块的猪圈给之后选这些的顾客提供猪呢？只需将之前并在一块的猪圈对应的顾客i向当前的顾客j连一条边即可。

### P3254 圆桌问题

这个甚至不需要用网络流来做。。

直接贪心。

### CF510E Fox And Dinner

这题也有点意思。

经验丰富的选手，看到相加为质数，考虑奇偶划分点集。由于至少3个点围成一桌，那么就证明每个点必有两个 **相邻** 点。每个点要跑2流量才行，即要满流。

### P3097 [USACO13DEC]Optimal Milking G

经典二分跑图。

### P2891 [USACO07OPEN]Dining G

经典三分图。对于中间匹配节点，要拆点保证只流一次。

### P2754 [CTSC1999]家园 / 星际转移问题

这一题，很有意思！

多了一维时间，而普通的网络流是不包含时间这一维的（即一瞬间流完）。那么就将除S，T外的站点按时间构建分层图。现在有一个飞船，在第T天停留在u，第T+1天停留在v，可以载人c，则点(u,T)->(v,T+1)一条c的流量边。由于空间站可以无限时间滞留人，故(u,T)->(u,T+1)一条inf的流量边。当第T天能跑满最大流，那就是第T天能送完人。

### P5038 [SCOI2012]奇怪的游戏

经验丰富的选手首先会注意到，要是可以加到某个数，是不是改设为x？

多米诺加法过程，故黑白染色。

对于每个白点黑点啊，那就得$\sum x - a_{白} = \sum x - a_{黑}$。看看这个式子，如果矩阵的元素为奇（我先染白），则白点个数更多，那就有$x = \sum a_{白} - \sum a_{黑}$。由于只是能+，不能-，所以求出来的x，要是$<max(a_白,a_黑)$则必挂。那么x不就确定了？那么跑个网络流，看看是否满流就完事了呀。

对于矩阵元素个数为偶，那就只能二分了（由于必能完整覆盖一层多米诺）。

### P5771 [JSOI2016]反质数序列

有点意思的题目。

经验丰富的选手，看到相加不为质数，那么就考虑奇偶分（1只能保留1个）。考虑都选上，然后互为质数的必要丢掉一个，跑个最小割就行。

### P2598 [ZJOI2009]狼和羊的故事

这题有点意思。

首先知道，狼和羊之间的一条路肯定是至少放一个栅栏的。

故羊连汇点S，羊跟地，羊跟狼连边，地跟地，地跟狼连边，狼跟汇点连边，然后跑个最小割即可。

### P2057 [SHOI2007]善意的投票 / [JLOI2010]冠军调查

突然变成了水题。

首先必然是左点集为不睡觉，右点集为睡觉。朋友间就连一条边代表发生冲突的代价。然后跑个最小割就好了。

### P3756 [CQOI2017]老C的方块

目前做过的最有意思的网络流题目。

由于处理的方块可以旋转，镜像，处理的情况爆炸，经验丰富的选手就该考虑其共性。

不管旋转，镜像，始终有两个左右方格中间夹着一个蓝线。然后左右方格各自再接一个相邻方块即是要去除的模型。

于是乎，黑白染色，一旦能构成4个方块相连的就非法。即把四个方块穿在一块，然后跑个最小割即可。

### P4174 [NOI2006] 最大获利

最大权闭合子图裸题。

### P2805 [NOI2009] 植物大战僵尸

这题贼有意思。

首先，由于僵尸是从右到左打植物的，那么对于植物来说，默认的就有右边植物保护左边植物！

其次，若一个保护关系成了环，那么环上的任意植物都不会被打死！

再者，被环直接或间接保护的植物也不会被打死！

于是只需要把环和被环保护的植物在图上删除掉，其他的植物就一定能顺序被打死！（不信就举两个例子，无敌的植物被不无敌的保护，不无敌的被无敌的植物保护，发现前者无影响反正不选无敌植物，后者会矛盾，无敌植物保护的植物也是无敌的）

考虑怎么删除。写topo的，都是通过入度为0的来队列判点啊！具体看「拓扑排序」。

忽略删除的点，就变成一个普通图了。这时候就是个裸的最大权闭合子图问题了。

### [牛客 Magic Slab](https://ac.nowcoder.com/acm/contest/847/F)

题意就是，点亮一行需要$a_i$费用，点亮一列需要$b_j$费用。一个魔法格被交叉覆盖就会有$c_{i,j}$收益。然后有些格子对存在关系，同时被点亮也会有$d_{i_1,j_1,i_2,j_2}$奖励。问最大奖励。

那就直接最小割嘛，就向对应行列连边。对于格子对奖励，就向两对行列连边，完事。

### CF1082G Petya and Graph

大水题。把边抽象成点就好了。

### P3329 [ZJOI2011]最小割 / 【模板】最小割树（Gomory-Hu Tree）

最小割树的原理。

随意挑两个点u,v，求这两个点的最小割。可以感性发现被割出来的两个点集中任挑两个点，都小于等于u-v的最小割。

于是乎，划分成两个集合，只考虑集合里的点对的最小割。

每次求完u,v的最小割，就将u，v连边。记住，这里的u，v，是在原图上的最小割，而不是在诱导子图里跑最小割。可以发现，构造出的最小割树，任意两点路径的最小值就是两个点的最小割。

于是题目就解决了，复杂度$O(n^3m)$，但实际很难跑满。

### P4015 运输问题

裸的费用流。

### P2770 航空路线问题

拆点限流量即可。

输出路径的话，写个dfs往回找就是。注意，如果是两个点直连，也是有方案的。

### P4013 数字梯形问题

水题。

### P3358 最长k可重区间集问题

板题。

首先区间只能用一次，故拆点。然后排序，将不相交的区间串起来。最后向每个区间的左点连S，右点连T，跑个最大费用最大流即可。

相当于找k次増广路，每次找最长的那个。

### P2045 方格取数加强版

经典建不同费用的题。

每个点拆点（这没问题吧？），连边时连条容量为1，费用为点权的边，再连一条容量为inf，费用为0的边。跑个费用流就没了。

### P4012 深海机器人问题

跟上题一样。

### P4016 负载平衡问题

水题。

### P1251 餐巾计划问题

好题。

关键是如何把行为给描述出来。

对于第i天，必然会产生 $r_i$ 份脏餐巾，故左点集为脏餐巾。S向每一天的脏餐巾连一条 $r_i$ 容量，费用为0的边。

对于第i天，必然要用 $r_i$ 份脏餐巾。故右点集为干净餐巾。右点集向T连一条 $r_i$ 容量，费用为0的边。

今天用的干净餐巾可以直接买，所以从S向右点集连一条单位费用的边。

今天的干净餐巾也可以从i-m天的脏餐巾通过洗干净得来，对应的就是洗的费用。

由于每天的脏餐巾可以继承，故i向i+1的脏餐巾连无费用边。

所有的行为都描述了出来，那么跑个费用流就完事了。

### P2053 [SCOI2007]修车

这个！老经典后面的人要等前面的人问题了。

经验丰富的选手立刻将问题倒过来。对于一个维修老同志，倒数第1个修的车给总时间+1 * 修车时间；倒数第2个修的车给总时间+2 * 修车时间；倒数第n个修的车给总时间+n * 修车时间。

故把老同志拆成车数个点，然后按倒数来顺序建边。跑个费用流，流量为总修车人数就是了。

另外有个优化，由于老同志 * 车数很大！那么可以动态的来加点。每次找到一条増广路，看看是哪个师傅修的，那么此时再往后加一个同个师傅，向每个车连倍数+1的边。

### P2050 [NOI2012] 美食节

跟上题一模一样。

要加优化。

### CF901C Bipartite Segments

这题很有意思。

无向图，无偶环。首先推出的信息是，图要不是无环图，要不是带奇环的图。

还能继续推。这个图必然是仙人掌图。考虑两个奇环有公共边，那么就必能找到一个偶环。反推回其为仙人掌图。

那么可以轻易用tarjan把所有环找出来。

对于一个环，最小标号和最大标号确定了奇环在数轴上的范围。对于任意选出来的合法区间，必不能 **包含** 一个奇环代表的连续区间。那么经验丰富的选手就考虑求当前点能往右延展至最长的合法区间nxt。对于这个啊，考虑加入一个非法区间，数轴上nxt的变化就知道如何求了。

很明显，nxt是单调不减的。于是对于一个区间，直接二分找到nxt大于等于r的位置，该位置此后的右区间直接限定在r。对于剩余的左边位置，直接求个前缀和即可（右区间不受限制）。

### CF724E Goods transportation

这道题很有意思。

很明显的网络流建图，但也很明显的$O(过不了)$。

首先经验丰富的选手先考虑动态建点。实质上是求S到T的最小割。那么每次加一个点，要不将这个点和S隔开，要不和T隔开。

那就令 $dp(i,j)$ 为选到第i个位置，还剩j个与S相连。

那么 $dp(i,j) = dp(i-1,j) + j * c + p_i$，代表i和S的所有可能连系都隔开。

$dp(i,j) = dp(i-1,j-1)+s_i$，代表i和T隔开。取max就是答案。

记得有些情况是非法的，初始化要初始化干净。

### P4001 [ICPC-Beijing 2006]狼抓兔子

对偶图模板题。

平面图的网络流 = 对偶图的最短路

首先源点和汇点都在同一个面里，要人为的把它们画成两个区域。

走对偶图的边，实际上就是原图从一个平面到另一个平面（用雨巨的话说就是打破面与面的屏障）

<img src="C:\Users\Administrator\Desktop\markdown图片\对偶图1.png" style="zoom:67%;" />

于是，就可以按照上面的划分方式，建点跑最短路即可。（这种题啊，就是要去标号，以求简洁）

### P4251 [SCOI2015]小凸玩矩阵

这个啊，这个感觉做一次就是水题了啊。

### Place the robots

网格图，有草地，有机器人，有墙。

只要机器人左右前后能看到另一个机器人，就会将其人道毁灭。不能隔着墙看见。问最少放多少个机器人。

这道题啊，就利用了一下网格图的性质了。

一开始若只是把机器人当做点，那就会成为一般图最大独立集问题。是个NP问题。

但按照下面的图的划分方式，则又可以把点当做边了！于是转化成求最大匹配。

<img src="C:\Users\Administrator\Desktop\markdown图片\place the robots.png" alt="place the robots" style="zoom:67%;" />

### CF277E Binary Tree on Plane

现在看来就是费用流水题了。

对于任意多叉树的非网络流解法介绍一下。

对于边，按高度高为第一关键字，高度相同，按边权小为第二关键字。排序，然后按照Kruskal来生成一棵树。

### CF316C2 Tidying Up

比较经典的带权网络流题目。

注意啊，是求最少的与原图位置不同的鞋子的数量。所以相邻不同的连一条有费用的边，否则费用为0，跑费用流就是了。

不是最小割啊！自己想想为啥不是。

### CF37E Trial for Chief

[比较有理的题解](https://wenku.baidu.com/view/659cd8c1b14e852458fb5761.html)

### P2604 [ZJOI2010]网络扩容

做一次就会做题目。

费用嘛，那就对于每条原先的边再建多一条边呗。容量为k，单位费用为1的边。

跑费用流就完事了。

### CF362E Petya and Pipes

跟上题一样的建图。

问题是，怎么统计在限定的金钱下，流量的增量呢？

那就从费用流本身下手啊！$d[t]$存的就是单位流量流向t最少花的费用。如果金钱足够，那就直接流满；如果金钱不够了，那就看剩余的金钱够走多少次从s->t。即$\frac{left}{d[t]}$，向下取整。

### P3227 [HNOI2013]切糕

最小割！

经验丰富的选手啊，一眼一看！一个位置的高度只能选一种啊！

于是，先不管位置间的限制，那就是每个位置要割一条代表的边啊！

然后去考虑限制。

一个位置选了某一个数u，那么对于另一个数，是不是必须要割u-D以后的数v哇？（你割了前面，那后面的点由于u那可以提供流量，所以就割不断啊）

于是就建好边，跑个最小割就是了。

### CF720B Cactusophobia

不是环上的边，怎么可以删！

环上的边，是不是只用删一条！

最大流！

建点做限制就完事！记住是每种颜色存在仅算一次！

### CF884F Anti-Palindromize

经验丰富的选手啊，一看这个位置为a的，最后要是也放了a，是不是可以理解成没动啊？

那就按字符把字符全拿出来。

对于一个位置，还放原先字符的，那就有贡献。

还有一个问题，对称位置不能放同一种字符。那么限制拆成26种字符，每种字符仅流出1的流量就是了！

### CF863F Almost Permutation

有点像修车！

但是，对于来什么位置，贡献都是一样！所以只用一个点就完事！

### 混合图欧拉回路

混合图的欧拉回路，无向边只走一次的啊。

首先啊，随机定向边。

如果边的入度和出度之差为奇数，那么不管怎么换边方向也是奇数，必挂。

否则，就再跑网络流看看是否有解。

具体的，将原来的有向边删掉！然后呢，在原来的已定向边，建图。S向入度小于出度的点连边，T向入度大于出度的点连边。能满流就存在欧拉回路。